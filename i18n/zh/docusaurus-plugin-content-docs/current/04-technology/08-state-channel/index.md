# P2P 网络上的状态通道

状态通道（State Channel），或者叫支付通道（Payment Channel），以闪电网络（Lightning Network）为代表，是一种比较成熟的扩容方案。它的思路是双方各自抵押一定额度的资产在链上，然后在链下维护一个只包含参与方的局部共识状态，每次交易只需要参与方一起确认，所以可以支持通道中的高频交易。

但因为当前的状态通道都是架设在 Layer1 之上，创建通道的费用和时间成本都很高，无法直接用在 P2P 网络中。

而 Rooch 提供了安全以及即时的确认交易的能力，以及低廉的交易费用，使得 P2P 网络中的节点可以在创建网络连接的同时，把它升级成为一个状态通道，从而在 P2P 网络中实现高频[流式支付](./01-streaming-payment.md)。

同时，Rooch 通过 Move 的状态特性，支持在[状态通道中执行智能合约](./02-channel-contract.md)，简化 P2P 网络上的游戏以及 DApp 协议的设计。

![p2p](/diagram/rooch-p2p.svg)

## 状态通道的表达

每个状态通道实际上是一个由通道的参与方在执行层维护的 RST，所以也可以沿用[状态迁移](../06-state-scaling.md)模式，实现状态从执行层到状态通道的迁移。

:::note

TODO 通过 Move 合约来表达

:::

## 开启状态通道（Opening the channel）

通道参与方（一般是双方，但也可以扩展到多方），在 Rooch 执行层抵押初始化资金，初始化 RST，开启状态通道。

由于 Rooch 执行层的交易是即时确认的，所以用户可以为每个场景开启一个状态通道，比如每局游戏一个状态通道。

## 使用状态通道（Using the channel）

Rooch 状态通道上的交易和执行层的交易一样，都是执行一个智能合约的方法，然后触发状态的变化。关键区别是状态通道上的合约只能修改通道中的状态，但状态通道中的合约依然可以读取 Layer1 和执行层的状态，实现一些复杂的逻辑。比如参与方可以根据 Layer1 Oracle 中的价格在状态通道中交换。


## 关闭状态通道（Closing the channel）

状态通道的关闭由三种情况：

1. 协作式关闭，所有参与方同意的情况下，会即时从执行层清算。
2. 等待超时被动关闭，以最后一次参与方共同确认的状态树根进行结算。超时时长可由参与方在开启通道时协商设置。
3. 一方作弊欺诈，另外的参与方可以通过[欺诈证明](../02-fraud-proofs.md)，在 Rooch 执行层发起仲裁申请，由仲裁合约进行清算。


* [流式支付](01-streaming-payment.md)
* [状态通道合约](02-channel-contract.md)